<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Rails中自定义错误页面 · 人依旧♀Blog</title><meta name="description" content="Rails中自定义错误页面 - 人依旧"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yijiu.ren/atom.xml" title="人依旧♀Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">Archive</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="https://github.com/renyijiu" target="_blank" class="nav-list-link">GitHub</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">Rss</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Rails中自定义错误页面</h1><div class="post-info">2016年10月30日</div><div class="post-content"><p>Rails中当出现500和404错误时，默认使用的是Public下的错误页面，如500.html。在开发过程中或者是一些内部应用中，我们希望可以将错误信息暴露出来，以方便我们快速定位及解决问题。那么我们可以对错误页面的信息进行自定义。<a id="more"></a></p><h2 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h2><p>首先需要在config中开启这个设定，使用自定义的错误方式。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># config/application.rb   </span></div><div class="line">config.exceptions_app = <span class="keyword">self</span>.routes</div></pre></td></tr></table></figure><p>设定后应该就是使用自己的错误定义了，也可以将public下的错误页面删了，不删也没什么关系。</p><h2 id="定义错误动作"><a href="#定义错误动作" class="headerlink" title="定义错误动作"></a>定义错误动作</h2><p>使用自己的错误定义后，那就和其他的操作一样，首先定义路由跳转</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#通过数组定义错误代码，自己定制 </span></div><div class="line"><span class="string">%w(404 500)</span>.each <span class="keyword">do</span> <span class="params">|code|</span></div><div class="line">     match code, <span class="symbol">to:</span> <span class="string">"error#show"</span>, <span class="symbol">code:</span> code, <span class="symbol">:via</span> =&gt; [<span class="symbol">:get</span>, <span class="symbol">:post</span>, <span class="symbol">:put</span>, <span class="symbol">:patch</span>, <span class="symbol">:delete</span>]</div><div class="line"> <span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#正则表达式匹配路由，这个是项目使用的一种，将服务器错误（5XX）进行跳转</span></div><div class="line">match <span class="string">'/:code'</span>, <span class="symbol">to:</span> <span class="string">"error#show"</span>, <span class="symbol">code:</span> <span class="symbol">:code</span>, <span class="symbol">via:</span> <span class="symbol">:all</span>, <span class="symbol">:constraints</span> =&gt; &#123; <span class="symbol">:code</span> =&gt; <span class="regexp">/5(10|0\d)&#123;1&#125;/</span> &#125;</div></pre></td></tr></table></figure><p><strong>这里需要说一下</strong>，当请求出错，使用路由跳转时，原来的请求方式和请求参数会被携带着转向错误处理。例如，当使用get时，参数为params={“test”:”测试”}，这个请求服务器出错，路由跳转错误处理时，使用的依旧是get方式，并带有原来的参数，所以需要确定自己需要对那些请求方式进行处理，简单的使用via: :all对所有的http请求进行匹配。</p><p>在写好route后，需要相对应的cotroller文件</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorController</span> &lt; ApplicationController</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></div><div class="line">    <span class="comment">#自定义错误处理代码</span></div><div class="line">    ......</div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure><p>如果需要将错误的log信息显示，可以通过环境变量去进行提取</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#获取错误log信息，进行自定义显示</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">env_exception</span></span></div><div class="line">  @ex <span class="params">||</span>= env[<span class="string">'action_dispatch.exception'</span>]</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">@err_mess = env_exception ? env_exception.message : <span class="string">''</span></div><div class="line">@err_info = env_exception ? env_exception.backtrace.join(<span class="string">"\n"</span>) : <span class="string">''</span></div></pre></td></tr></table></figure><h2 id="Rails内自带的500错误提示"><a href="#Rails内自带的500错误提示" class="headerlink" title="Rails内自带的500错误提示"></a>Rails内自带的500错误提示</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="string">"500 Internal Server Error\n"</span> </div><div class="line"><span class="string">"If you are the administrator of this website, then please read this web application's log file and/or the web server's log file to find out what went wrong."</span></div></pre></td></tr></table></figure><p>这个是Rails自带的错误提示，当你自定义的错误页面代码出错时，无法展示了，就会转向这个告诉你出问题了，这是你就需要检查自己的错误信息页面哪里出问题了。</p><h2 id="其它的思路"><a href="#其它的思路" class="headerlink" title="其它的思路"></a>其它的思路</h2><p>自定义错误信息也不一定去展示，在<code>error#show</code>中可以进行一些有趣的操作，常见的是加入邮件发送，通知管理员出问题了。另外也可以去调用一些消息通知，例如，添加一个钉钉的消息通知接口，出现错误后调用接口，将错误日志发给管理员，更加方便快捷。</p><p>总的来说，这个自定义错误还是比较实用的，可以提高错误的通知效率，使得错误快速定位并解决，而不是说用户无法使用抱怨了，这才发现线上环境出现了错误。</p></div></article></div></section><footer><div class="paginator"><a href="/2016/10/26/Action-Cable的使用分析/" class="prev">上一篇</a><a href="/2017/04/05/node-js开发指南-学习笔记/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2017 <a href="http://yijiu.ren">人依旧</a>, Live For Dream, Dream For Love.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>!function(e,t,a,n,c,o){e.GoogleAnalyticsObject=n,e[n]||(e[n]=function(){(e[n].q=e[n].q||[]).push(arguments)}),e[n].l=+new Date,c=t.createElement(a),o=t.getElementsByTagName(a)[0],c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script","ga"),ga("create","UA-78885477-1","auto"),ga("send","pageview")</script></body></html>